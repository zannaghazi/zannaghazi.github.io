<!DOCTYPE html>
<html>
    <head>
		<title>Demo Scanner</title>
		<link rel="stylesheet" href="css/main.css">
		<link href="css/bootstrap.min.css" rel="stylesheet">
		
		<script src="js/jquery-2.1.1.min.js"></script>
	</head>
	
	<body>
		<div id="QR-Code" class="container" style="width:100%">
			<div class="panel panel-primary">
				<div class="panel-heading" style="display: inline-block;width: 100%;">
                    <h4 style="width:50%;float:left;">WebCodeCam.js Demonstration</h4>
                    <div style="width:50%;float:right;margin-top: 5px;margin-bottom: 5px;text-align: right;">
                    <select id="cameraId" class="form-control" style="display: inline-block;width: auto;"></select>
                    <button id="play" data-toggle="tooltip" title="Play" type="button" class="btn btn-success btn-sm"><span class="glyphicon glyphicon-play"></span></button>
                </div>
			</div>
			<div class="panel-body">
				<div class="col-md-6" style="text-align: center;">
					<div class="well" style="position: relative;display: inline-block;">
                        <canvas id="qr-canvas" width="320" height="240"></canvas>
                        <div class="scanner-laser laser-rightBottom" style="opacity: 0.5;"></div>
                        <div class="scanner-laser laser-rightTop" style="opacity: 0.5;"></div>
                        <div class="scanner-laser laser-leftBottom" style="opacity: 0.5;"></div>
                        <div class="scanner-laser laser-leftTop" style="opacity: 0.5;"></div>
                    </div>
					<div class="well" style="position: relative;" >
                        <label id="zoom-value" width="100">Zoom: 2</label>
                        <input type="range" id="zoom" value="20" min="10" max="30" onchange="Page.changeZoom();"/>
                    </div>
					<div class="caption">
                        <h3>Scanned result</h3>
                        <p id="scanned-QR"></p>
                    </div>
				</div>
				<div class="panel-footer">
					<br>
					<p>Version: 1.0.1</p>
				</div>
			</div>
		</div>
	</body>
	<script>
		'use strict';
		var decoder = $('#qr-canvas'),
			scannerLaser = $('.scanner-laser'),
			scanQR = $('#scanned-QR'),
			btnPlay = $('#play'),
			zoomValue = $('#zoom-value'),
			_zoom = $('#zoom');
		
		scannerLaser.css('opacity', .5);
		
		btnPlay.click(function(){
			alert("button is clicked");
			
			if(typeof decoder.data().plugin_WebCodeCam === "undefined"){
				decoder.WebCodeCam({
				videoSource: {
					id: $('select#cameraId').val(),
					maxWidth: 640,
					maxHeight: 480
				},
				autoBrightnessValue: 120,
				resultFunction: function(text, imgSrc) {
					scanQR.text(text);
					scannerLaser.fadeOut(150, function() {
						scannerLaser.fadeIn(150);
					});
				},
				getUserMediaError: function() {
					alert('Sorry, the browser you are using doesn\'t support getUserMedia');
				},
				cameraError: function(error) {
					var p, message = 'Error detected with the following parameters:\n';
					for (p in error) {
						message += p + ': ' + error[p] + '\n';
					}
					alert(message);
				}
				});
				sQ.text('Scanning ...');
				sv.removeClass('disabled');
				sp.click(function(event) {
					sv.addClass('disabled');
					sQ.text('Stopped');
					decoder.data().plugin_WebCodeCam.cameraStop();
				});
				spAll.click(function(event) {
					sv.addClass('disabled');
					sQ.text('Stopped');
					decoder.data().plugin_WebCodeCam.cameraStopAll();
				});
			} else {
				sv.removeClass('disabled');
				sQ.text('Scanning ...');
				decoder.data().plugin_WebCodeCam.cameraPlay();
			}
		});
			
			
		Page.changeZoom = function(param) {
			if (typeof decoder.data().plugin_WebCodeCam == "undefined") return;
			var value = typeof param != 'undefined' ? parseFloat(param.toPrecision(2)) : _zoom.val() / 10;				zoomValue.text(zoomValue.text().split(':')[0] + ': ' + value.toString());
			decoder.data().plugin_WebCodeCam.options.zoom = parseFloat(value);
			if (typeof param != 'undefined') _zoom.val(a * 10);
		}
			
		var getZomm = setInterval(function() {
			var temp;
			try {
			temp = decoder.data().plugin_WebCodeCam.optimalZoom();
			} catch (e) {
				temp = 0;
			}
			if (temp != 0) {
				Page.changeZoom(temp);
				clearInterval(getZomm);
				}
		}, 500);
			
		function gotSources(sourceInfos) {
			for (var i = 0; i !== sourceInfos.length; ++i) {
				var sourceInfo = sourceInfos[i];
				var option = document.createElement('option');
				option.value = sourceInfo.id;
				if (sourceInfo.kind === 'video') {
					var face = sourceInfo.facing == '' ? 'unknown' : sourceInfo.facing;
					option.text = sourceInfo.label || 'camera ' + (videoSelect.length + 1) + ' (facing: ' + face + ')';
					videoSelect.appendChild(option);
				}
			}
		}
			
		if (typeof MediaStreamTrack.getSources !== 'undefined') {
			var videoSelect = document.querySelector('select#cameraId');
			$(videoSelect).change(function(event) {
				if (typeof decoder.data().plugin_WebCodeCam !== "undefined") {
					decoder.data().plugin_WebCodeCam.options.videoSource.id = $(this).val();
					decoder.data().plugin_WebCodeCam.cameraStop();
					decoder.data().plugin_WebCodeCam.cameraPlay(false);
				}
			});
			MediaStreamTrack.getSources(gotSources);
		} else {
			document.querySelector('select#cameraId').remove();
		}
	});
	</script>
</html>